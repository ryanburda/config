#!/bin/bash

CONFIG_DIR="$HOME/.config/tsm"
mkdir -p $CONFIG_DIR

usage() {
  echo "Tmux Session Manager"
  echo ""
  echo "A combination of tmuxinator and tmux sessionizer"
  echo ""
  echo "Usage: tsm [OPTIONS] <session-name>"
  echo ""
  echo "Options:"
  echo "  -h, --help         Show this help message"
  echo "  -l, --list         List available sessions"
  echo "  -s, --stop         Stop session and run stop.sh if it exists"
  echo "  -f, --fzf          Use fzf to select from configured sessions"
  echo "                     This mimics the tmuxinator workflow"
  echo "  -d, --dir [path]   Use fzf to select a directory"
  echo "                     Runs \$TSM_DIRS_CMD if set, otherwise shows \$HOME + git repos"
  echo ""
  echo "Examples:"
  echo "  tsm myproject      Start or attach to session"
  echo "  tsm -s myproject   Stop session"
  echo "  tsm -l             List available sessions"
  echo "  tsm -f             Select from configured sessions"
  echo "  tsm -d             Browse directories (\$HOME + git repos)"
  echo "  tsm -d ~/projects  Browse directories from ~/projects"
  echo ""
  echo "Configuration:"
  echo "  Sessions are configured in \$HOME/.config/tsm/<session-name>/"
  echo ""
  echo "  start.sh  Required script that runs when starting a session."
  echo "            Use this to create tmux windows, panes, and run commands."
  echo ""
  echo "  stop.sh   Optional script that runs before killing a session."
  echo "            Use this for cleanup tasks like stopping services."
  echo ""
  echo "Environment Variables:"
  echo "  TSM_DIRS_CMD  Command to generate directories for 'tsm -d'."
  echo "                The command is evaluated at runtime and piped to fzf."
  echo ""
  echo "                Default (when unset): \$HOME + git repos within 3 levels"
}

list_sessions() {
  if [ ! -d "$CONFIG_DIR" ]; then
    echo "No sessions configured. Create directories in $CONFIG_DIR"
    return 1
  fi

  for dir in "$CONFIG_DIR"/*/; do
    [ -d "$dir" ] && echo "$(basename "$dir")"
  done
}

start_session() {
  local session="$1"
  local session_dir="$CONFIG_DIR/$session"

  if [ ! -d "$session_dir" ]; then
    echo "Error: Session '$session' not found in $CONFIG_DIR"
    return 1
  fi

  if [ ! -f "$session_dir/start.sh" ]; then
    echo "Error: No start.sh found for session '$session'"
    return 1
  fi

  # Check if session already exists
  if tmux has-session -t "$session" 2>/dev/null; then
    echo "Session '$session' already running, switching..."
    if [ -n "$TMUX" ]; then
      tmux switch-client -t "$session"
    else
      tmux attach-session -t "$session"
    fi
  else
    echo "Starting session '$session'..."
    bash "$session_dir/start.sh"
  fi
}

stop_session() {
  local session="$1"
  local session_dir="$CONFIG_DIR/$session"

  if ! tmux has-session -t "$session" 2>/dev/null; then
    echo "Error: Session '$session' is not running"
    return 1
  fi

  # Run stop.sh if it exists
  if [ -f "$session_dir/stop.sh" ]; then
    echo "Running stop script for '$session'..."
    bash "$session_dir/stop.sh"
  fi

  echo "Killing session '$session'..."
  tmux kill-session -t "$session"
}

format_sessions() {
  local configured_sessions
  configured_sessions=$(list_sessions 2>/dev/null)

  local active_sessions
  active_sessions=$(tmux ls 2>/dev/null | awk -F: '{print $1}')
  local current_session=$(tmux display-message -p '#S' 2>/dev/null)
  local previous_session=$(tmux display-message -p '#{client_last_session}' 2>/dev/null)

  local all_sessions
  all_sessions=$(printf "%s\n%s" "$configured_sessions" "$active_sessions" | sort -u | grep -v '^$')

  local RED=$'\033[31m'
  local GREEN=$'\033[32m'
  local YELLOW=$'\033[33m'
  local RESET=$'\033[0m'

  echo "$all_sessions" | while read -r session; do
    [ -z "$session" ] && continue
    if echo "$active_sessions" | grep -q "^${session}$"; then
      local indicator="  "
      if [ "$session" = "$current_session" ]; then
        indicator="${RED}% ${RESET}"
      elif [ "$session" = "$previous_session" ]; then
        indicator="${YELLOW}# ${RESET}"
      fi
      printf '%s|%s%s%s%s\n' "$session" "$indicator" "$GREEN" "$session" "$RESET"
    else
      printf '%s|  %s\n' "$session" "$session"
    fi
  done
}

fzf_session() {
  local formatted
  formatted=$(format_sessions)

  if [ -z "$formatted" ]; then
    echo "No sessions available"
    return 1
  fi

  local selected
  selected=$(echo "$formatted" | fzf \
    --cycle \
    --prompt "  > " \
    --ansi \
    --with-nth 2 \
    --delimiter '|')

  if [ -z "$selected" ]; then
    echo "No session selected"
    return 0
  fi

  # Extract session name from delimiter format
  selected=$(echo "$selected" | awk -F'|' '{print $1}')

  # Check if it's a configured session
  if [ -d "$CONFIG_DIR/$selected" ]; then
    start_session "$selected"
  else
    # It's an active but unconfigured session, just switch to it
    if [ -n "$TMUX" ]; then
      tmux switch-client -t "$selected"
    else
      tmux attach-session -t "$selected"
    fi
  fi
}

dir_session() {
  local search_dir="$1"

  # Use fzf to select a directory
  local selected

  # If no search dir provided, check TSM_DIRS_CMD first
  if [ -z "$search_dir" ]; then
    if [ -n "$TSM_DIRS_CMD" ]; then
      selected=$(eval "$TSM_DIRS_CMD" | fzf)
    else
      # Default: HOME + git repos within 3 levels
      selected=$({ echo "$HOME"; find "$HOME" -maxdepth 3 -type d -exec test -d '{}/.git' \; -print -prune 2>/dev/null; } | fzf)
    fi
  fi

  # If no selection yet, use find
  if [ -z "$selected" ]; then
    # Expand tilde if present
    search_dir="${search_dir/#\~/$HOME}"

    if [ ! -d "$search_dir" ]; then
      echo "Error: Directory '$search_dir' does not exist"
      return 1
    fi

    selected=$(find "$search_dir" -type d 2>/dev/null | fzf)
  fi

  if [ -z "$selected" ]; then
    echo "No directory selected"
    return 0
  fi

  # Resolve to absolute path
  selected=$(cd "$selected" && pwd -P)

  local session_name
  session_name=$(basename "$selected")

  # Check if session already exists
  if tmux has-session -t "$session_name" 2>/dev/null; then
    echo "Session '$session_name' already running, switching..."
    if [ -n "$TMUX" ]; then
      tmux switch-client -t "$session_name"
    else
      tmux attach-session -t "$session_name"
    fi
  else
    echo "Starting new session '$session_name' in $selected..."
    if [ -n "$TMUX" ]; then
      tmux new-session -d -s "$session_name" -c "$selected"
      tmux switch-client -t "$session_name"
    else
      tmux new-session -s "$session_name" -c "$selected"
    fi
  fi
}

# Parse arguments
if [ $# -eq 0 ]; then
  usage
  return 0
fi

case "$1" in
  -l|--list)
    list_sessions
    ;;
  -s|--stop)
    if [ -z "$2" ]; then
      echo "Error: Session name required for --stop"
      return 1
    fi
    stop_session "$2"
    ;;
  -f|--fzf)
    fzf_session
    ;;
  -d|--dir)
    dir_session "$2"
    ;;
  -h|--help)
    usage
    ;;
  -*)
    echo "Error: Unknown option '$1'"
    usage
    return 1
    ;;
  *)
    start_session "$1"
    ;;
esac
